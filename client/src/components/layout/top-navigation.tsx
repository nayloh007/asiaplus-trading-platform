import { useAuth } from "@/hooks/use-auth";
import { Button } from "@/components/ui/button";
import { useLocation } from "wouter";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { ThemeToggle } from "@/components/theme-toggle";
import { formatCurrency } from "@/lib/formatters";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

interface TopNavigationProps {
  title?: string;
  showBackButton?: boolean;
  onBack?: () => void;
  actionButton?: React.ReactNode;
}

export function TopNavigation({ title = "บิทคับ", showBackButton = false, onBack, actionButton }: TopNavigationProps) {
  const { user, logoutMutation } = useAuth();
  const [, setLocation] = useLocation();

  const handleLogout = () => {
    logoutMutation.mutate();
    setLocation("/auth");
  };

  const getInitials = (name: string) => {
    return name
      .split(" ")
      .map((n) => n[0])
      .join("")
      .toUpperCase();
  };

  return (
    <nav className="sticky top-0 z-10 bg-card/80 backdrop-blur-sm border-b border-border py-3">
      <div className="flex justify-between items-center px-4">
        <div className="flex items-center">
          {showBackButton && (
            <button onClick={onBack} className="mr-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5">
                <path d="m15 18-6-6 6-6" />
              </svg>
            </button>
          )}
          <div className="text-xl font-bold flex items-center">
            <img 
              src="/images/bitkub-logo.png" 
              alt="โลโก้บิทคับ" 
              className="h-8 mr-2" 
            />
            <span className={title === "บิทคับ" ? "hidden" : ""}>{title}</span>
          </div>
        </div>
        
        <div className="flex items-center space-x-2">
          <ThemeToggle />
          
          {actionButton ? (
            <div>{actionButton}</div>
          ) : !user ? (
            <a 
              href="https://line.me/ti/p/~oeasy24" 
              target="_blank" 
              rel="noopener noreferrer"
              className="flex items-center"
            >
              <Button
                variant="default"
                size="sm"
                className="flex items-center gap-1 bg-[#06C755] hover:bg-[#06B048] text-white"
              >
                <svg width="16" height="16" viewBox="0 0 32 32" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M27 14.8751C27 10.3876 22.1813 6.75 16.2436 6.75C10.3059 6.75 5.48718 10.3876 5.48718 14.8751C5.48718 18.8658 9.24563 22.1788 14.3655 22.8837C14.6996 22.9479 15.1534 23.0816 15.2471 23.3643C15.3323 23.6204 15.2898 24.0273 15.2471 24.3176C15.2471 24.3176 15.0981 25.1495 15.0639 25.2995C15.0087 25.5528 14.8172 26.3792 16.2436 25.7954C17.6699 25.2116 23.5492 21.5292 26.0005 18.5304L26.0016 18.5288C26.664 17.4625 27 16.2059 27 14.8751Z"/>
                  <path d="M13.2082 13.3209H12.4059C12.2452 13.3209 12.1145 13.4516 12.1145 13.6123V17.8724C12.1145 18.0332 12.2452 18.1639 12.4059 18.1639H13.2082C13.369 18.1639 13.4997 18.0332 13.4997 17.8724V13.6123C13.4997 13.4516 13.369 13.3209 13.2082 13.3209Z"/>
                  <path d="M20.12 13.3209H19.3178C19.157 13.3209 19.0264 13.4516 19.0264 13.6123V17.8724C19.0264 18.0332 19.157 18.1639 19.3178 18.1639H20.12C20.2808 18.1639 20.4115 18.0332 20.4115 17.8724V13.6123C20.4115 13.4516 20.2808 13.3209 20.12 13.3209Z"/>
                  <path d="M16.6642 13.3209H15.862C15.7012 13.3209 15.5705 13.4516 15.5705 13.6123V16.1896L13.9505 13.4478C13.9447 13.4385 13.9382 13.4293 13.9312 13.4206L13.9282 13.4169C13.9227 13.4097 13.9167 13.4029 13.9102 13.3964L13.9067 13.3927C13.9015 13.3875 13.896 13.3824 13.8903 13.3777L13.8865 13.3747C13.881 13.3704 13.8755 13.3664 13.8697 13.3627C13.867 13.3612 13.864 13.36 13.861 13.3582C13.8555 13.3552 13.85 13.3524 13.8442 13.3497C13.8415 13.3487 13.8385 13.3474 13.8357 13.3462C13.83 13.3437 13.8245 13.3414 13.8187 13.3394C13.816 13.3384 13.8132 13.3372 13.8102 13.3364C13.8045 13.3344 13.7987 13.3329 13.7932 13.3314C13.7902 13.3307 13.7875 13.3299 13.7845 13.3292C13.7785 13.3279 13.7727 13.3267 13.7667 13.3259C13.764 13.3254 13.761 13.3252 13.7582 13.3249C13.752 13.3242 13.746 13.3239 13.7397 13.3234C13.7367 13.3234 13.734 13.3232 13.731 13.3229C13.7252 13.3229 13.7195 13.3227 13.7137 13.3227C13.7077 13.3227 13.702 13.3227 13.696 13.3229C13.6932 13.3229 13.6902 13.3232 13.6875 13.3232C13.6817 13.3234 13.676 13.3239 13.67 13.3242C13.667 13.3244 13.6642 13.3247 13.6612 13.3249C13.6555 13.3254 13.6497 13.3264 13.644 13.3272C13.641 13.3274 13.638 13.3279 13.635 13.3282C13.6292 13.3292 13.6235 13.3302 13.618 13.3312C13.615 13.3317 13.612 13.3322 13.609 13.3329C13.6035 13.3339 13.5982 13.3354 13.593 13.3367C13.5895 13.3374 13.5865 13.3382 13.5835 13.3389C13.5782 13.3404 13.573 13.3419 13.5677 13.3434C13.5647 13.3444 13.5617 13.3452 13.5587 13.3462C13.5537 13.3479 13.5485 13.3499 13.5435 13.3517C13.5407 13.3527 13.5377 13.3537 13.5347 13.3549C13.5295 13.3569 13.5245 13.3592 13.5195 13.3614C13.5168 13.3627 13.5137 13.3637 13.5107 13.3649C13.5057 13.3674 13.5007 13.3697 13.496 13.3722C13.493 13.3737 13.4902 13.3749 13.4872 13.3762C13.4825 13.3789 13.4777 13.3817 13.4732 13.3844C13.4702 13.3859 13.4675 13.3874 13.4645 13.3889C13.4597 13.3919 13.4552 13.3949 13.4507 13.3979C13.448 13.3994 13.445 13.4011 13.4425 13.4029C13.438 13.4061 13.4335 13.4094 13.4292 13.4124C13.4265 13.4144 13.4235 13.4161 13.4212 13.4179C13.4167 13.4214 13.4125 13.4246 13.4082 13.4281C13.4057 13.4299 13.403 13.4316 13.4007 13.4334C13.3965 13.4371 13.3925 13.4409 13.3885 13.4446C13.3862 13.4464 13.3837 13.4481 13.3815 13.4501C13.3777 13.4541 13.3737 13.4581 13.3702 13.4621C13.3682 13.4641 13.3657 13.4661 13.3637 13.4679C13.36 13.4724 13.3565 13.4769 13.353 13.4814C13.351 13.4834 13.3487 13.4857 13.3467 13.4879C13.3435 13.4927 13.3402 13.4974 13.337 13.5022C13.353 13.5022 13.3365 13.5044 13.336 13.5051C13.336 13.5079 13.3342 13.5104 13.333 13.5129C13.34 13.5177 13.3272 13.5224 13.3242 13.5272C13.3222 13.5299 13.3205 13.5329 13.3187 13.5357C13.3157 13.5407 13.313 13.5454 13.3102 13.5504C13.3085 13.5534 13.307 13.5564 13.3052 13.5594C13.3025 13.5646 13.3 13.5699 13.2975 13.5751C13.296 13.5784 13.2945 13.5814 13.293 13.5846C13.2907 13.5899 13.2885 13.5957 13.2865 13.6013C13.2855 13.6045 13.2842 13.6075 13.2832 13.6108C13.2812 13.6168 13.2795 13.6226 13.278 13.6286C13.277 13.6318 13.2762 13.6351 13.2755 13.6383C13.274 13.6448 13.2727 13.6513 13.2715 13.6578C13.2707 13.6608 13.2702 13.6641 13.2697 13.6673C13.2687 13.6743 13.2682 13.6813 13.2677 13.6883C13.2672 13.6916 13.267 13.6948 13.2667 13.698C13.2662 13.7055 13.2662 13.7135 13.2662 13.7213C13.2662 13.7223 13.2662 13.7233 13.2662 13.7243V17.8724C13.2662 18.0332 13.3969 18.1639 13.5577 18.1639H14.3599C14.5207 18.1639 14.6514 18.0332 14.6514 17.8724V15.2952L16.2724 18.0394C16.2887 18.0667 16.309 18.0902 16.3325 18.1092C16.333 18.1095 16.3335 18.11 16.334 18.1105C16.3377 18.1132 16.3415 18.116 16.3452 18.1185C16.3482 18.1205 16.3512 18.1225 16.3542 18.1243C16.3577 18.1265 16.3615 18.1285 16.365 18.1305C16.3685 18.1325 16.372 18.1343 16.3755 18.136C16.379 18.1377 16.3825 18.1395 16.386 18.141C16.3897 18.1425 16.3937 18.1442 16.3975 18.1457C16.401 18.147 16.4045 18.1482 16.408 18.1492C16.4115 18.1502 16.415 18.1512 16.4185 18.1522C16.4222 18.1532 16.4262 18.1539 16.43 18.1547C16.4335 18.1554 16.437 18.1557 16.4405 18.1562C16.4445 18.1567 16.4482 18.1574 16.452 18.1577C16.4555 18.1579 16.459 18.1582 16.4625 18.1584C16.4662 18.1584 16.47 18.1589 16.4737 18.1589H16.4775C16.481 18.1589 16.4845 18.1589 16.488 18.1589C16.492 18.1587 16.496 18.1584 16.5 18.1579C16.5032 18.1577 16.5065 18.1572 16.5097 18.1569C16.5137 18.1564 16.5175 18.1557 16.5215 18.155C16.5247 18.1544 16.528 18.1539 16.5315 18.1532C16.5355 18.1524 16.5392 18.1514 16.543 18.1504C16.5462 18.1494 16.5495 18.1484 16.5527 18.1474C16.5567 18.1462 16.5602 18.1447 16.564 18.1432C16.5672 18.1422 16.5705 18.1409 16.5737 18.1397C16.5775 18.1382 16.581 18.1365 16.5845 18.1347C16.5877 18.1332 16.591 18.1317 16.594 18.1302C16.5977 18.1282 16.6015 18.1265 16.605 18.1242C16.608 18.1227 16.611 18.1209 16.614 18.1192C16.6177 18.1167 16.6212 18.1142 16.6247 18.1117C16.6275 18.1097 16.6305 18.1077 16.6332 18.1059C16.6367 18.1032 16.6402 18.1004 16.6437 18.0974C16.6465 18.0957 16.6492 18.0934 16.6517 18.0914C16.655 18.0884 16.6585 18.0852 16.6617 18.0822C16.6642 18.0799 16.667 18.0777 16.6695 18.0754C16.6727 18.0721 16.6762 18.0686 16.6792 18.0654C16.6815 18.0629 16.684 18.0604 16.6862 18.0579C16.6895 18.0544 16.6925 18.0506 16.6955 18.0471C16.6977 18.0444 16.7 18.0416 16.702 18.0391C16.705 18.0354 16.708 18.0316 16.7107 18.0279C16.7127 18.0251 16.715 18.0221 16.7167 18.0191C16.7195 18.0149 16.7222 18.0111 16.7247 18.0069C16.7267 18.0036 16.7287 18.0004 16.7305 17.9971C16.7327 17.9929 16.735 17.9886 16.7372 17.9846C16.7387 17.9811 16.7407 17.9778 16.7422 17.9743C16.7442 17.9703 16.7462 17.9661 16.748 17.9618C16.7495 17.9578 16.751 17.9541 16.7525 17.9501C16.754 17.9463 16.7555 17.9424 16.757 17.9384C16.758 17.9344 16.7592 17.9306 16.7605 17.9266C16.7617 17.9226 16.7632 17.9186 16.7642 17.9146C16.7652 17.9111 16.7662 17.9073 16.7672 17.9036C16.7682 17.8996 16.7692 17.8958 16.7702 17.8918C16.771 17.8881 16.7717 17.8843 16.7725 17.8806C16.7732 17.8768 16.774 17.8731 16.7747 17.8694C16.7752 17.8654 16.7757 17.8616 16.7762 17.8578C16.7767 17.8541 16.7772 17.8504 16.7775 17.8464C16.7777 17.8429 16.7782 17.8391 16.7785 17.8354C16.7787 17.8316 16.7787 17.8279 16.7787 17.8241C16.779 17.8204 16.779 17.8164 16.779 17.8127V13.6123C16.7787 13.4516 16.648 13.3209 16.4872 13.3209H16.6642Z"/>
                  <path d="M18.2235 14.5776H16.4467C16.2859 14.5776 16.1553 14.7082 16.1553 14.869C16.1553 15.0298 16.2859 15.1605 16.4467 15.1605H16.9984V17.8724C16.9984 18.0332 17.1291 18.1639 17.2899 18.1639H18.0921C18.2529 18.1639 18.3836 18.0332 18.3836 17.8724V15.1605H18.9353C19.0961 15.1605 19.2267 15.0298 19.2267 14.869C19.2267 14.7082 19.0961 14.5776 18.9353 14.5776H18.2235Z"/>
                </svg>
                <span>ติดต่อไลน์</span>
              </Button>
            </a>
          ) : (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <div className="flex items-center cursor-pointer rounded-full bg-primary py-1 px-3 text-primary-foreground">
                  <span className="font-medium">{formatCurrency(Number(user.balance))}</span>
                </div>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem className="font-medium">{user.fullName}</DropdownMenuItem>
                <DropdownMenuSeparator />
                {user.role === "admin" && (
                  <DropdownMenuItem onClick={() => setLocation("/admin")}>
                    แอดมินแดชบอร์ด
                  </DropdownMenuItem>
                )}
                <DropdownMenuItem onClick={handleLogout} className="text-destructive">
                  ออกจากระบบ
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          )}
        </div>
      </div>
    </nav>
  );
}